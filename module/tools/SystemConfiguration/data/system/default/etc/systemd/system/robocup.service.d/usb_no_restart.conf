# This adds a condition to the robocup service to prevent it from starting if
# any USB devices are connected that are not in the allowlist. This is useful
# for preventing the service from restarting mid-competition while we are
# fixing a robot - any keyboard, usb monitor, etc. will stop it.

[Service]
ExecCondition=/bin/bash -c '
    ALLOWLIST="/etc/systemd/system/robocup.service.d/usb_allowlist.conf"
    comm -23 \
      <(lsusb | awk '"'"'{print tolower($6)}'"'"' | sort -u) \
      <(grep -vE "^\s*#|^\s*$" "$ALLOWLIST" \
        | cut -d"#" -f1 \
        | awk '"'"'{$1=$1; print tolower($0)}'"'"' \
        | sort -u) \
      | grep -q . && exit 1 || exit 0
'
