/*
 * MIT License
 *
 * Copyright (c) 2019 NUbots
 *
 * This file is part of the NUbots codebase.
 * See https://github.com/NUbots/NUbots for further info.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

#include <Eigen/Core>
#include <array>
#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>
#include <utility>

#include "utility/math/quaternion.hpp"

using Catch::Matchers::WithinAbs;

static const std::array<Eigen::Quaterniond, 200> Q = {
    Eigen::Quaterniond(0.812886533020004, -0.185088524394760, -0.548059268662397, -0.0677403912398385),
    Eigen::Quaterniond(-0.214630848051777, 0.688974792966896, 0.151003411000866, -0.675607359038444),
    Eigen::Quaterniond(-0.950289532310256, 0.230650194261699, -0.126724553079954, -0.166406671486698),
    Eigen::Quaterniond(0.342873593144920, -0.246777843934526, 0.846562838599658, 0.323836000421522),
    Eigen::Quaterniond(0.674341270754109, 0.754363498674194, 0, 0),
    Eigen::Quaterniond(0.942999276622527, 0.569704854566048, 0, 0),
    Eigen::Quaterniond(-0.886134229129504, -0.0700914333709315, 0.437579960091732, -0.135562153491254),
    Eigen::Quaterniond(-0.0993523745330940, 0.627953853641868, -0.237652538408431, 0.734387046698805),
    Eigen::Quaterniond(0.164940603472574, 0.796888274360241, -0.580597801213305, 0.0258818225698356),
    Eigen::Quaterniond(0.373275628992606, -0.141522913770345, -0.489256827763586, 0.775412358790365),
    Eigen::Quaterniond(0.438865505191996, -0.331341160755561, -0.194602902552738, -0.812243691178812),
    Eigen::Quaterniond(0.300081503850782, 0.193294208890493, -0.461199395067320, -0.812332172110394),
    Eigen::Quaterniond(0.453829101825304, 0.803981617413124, -0.269393683399984, 0.274006840320464),
    Eigen::Quaterniond(-0.252304668320037, 0.404132898719352, 0.637522570428254, 0.605461746695167),
    Eigen::Quaterniond(0.163164166425732, -0.245089795858270, 0.519893631027202, 0.801884691946479),
    Eigen::Quaterniond(-0.767762974441199, 0.469911850860029, 0.398323775201685, -0.176241418536002),
    Eigen::Quaterniond(-0.884691277570256, 0.908205572942427, 0, 0),
    Eigen::Quaterniond(0.959530447951973, 0.0856262262071024, 0.210497229944024, 0.166314115529948),
    Eigen::Quaterniond(-0.430352546278765, 0.0802116647187317, -0.778943147895290, 0.449010408678251),
    Eigen::Quaterniond(0.189948597619193, -0.377780720791996, 0.393027898379132, -0.816535564660881),
    Eigen::Quaterniond(0.924322062022520, -0.857530856150833, 0, 0),
    Eigen::Quaterniond(-0.628443473182843, -0.636039065661957, -0.371959974445663, -0.249316837329795),
    Eigen::Quaterniond(-0.613920368045947, -0.814022146258644, 0, 0),
    Eigen::Quaterniond(-0.316711790709717, -0.0730215044755136, 0.598393148135876, 0.732316285339615),
    Eigen::Quaterniond(0.865795791636161, -0.981334975944461, 0, 0),
    Eigen::Quaterniond(-0.218664926764808, 0.830051823471580, 0.366823324124539, 0.358664563391298),
    Eigen::Quaterniond(-0.453566584000073, 0.285483478266208, 0.681457844114248, -0.498389149370945),
    Eigen::Quaterniond(-0.696105840306312, -0.997161883595194, 0, 0),
    Eigen::Quaterniond(-0.205782314513097, -0.939229455010165, -0.187495547211865, 0.200865849886598),
    Eigen::Quaterniond(-0.250555066097515, -0.583059553389361, -0.737893271150674, -0.229732967692553),
    Eigen::Quaterniond(-0.737770585913989, -0.0900677099958056, 0.564432930074433, -0.359162689632192),
    Eigen::Quaterniond(-0.129918564208746, -0.745467933349733, 0.650244915516460, -0.0676777427682638),
    Eigen::Quaterniond(-0.816973665574778, -0.982704624243819, 0, 0),
    Eigen::Quaterniond(0.229253916025892, 0.454159202297054, -0.418148154423071, 0.752551780217333),
    Eigen::Quaterniond(-0.978041815418377, -0.291767067886827, 0, 0),
    Eigen::Quaterniond(0.146520766526745, 0.560891892192049, 0.220327153534072, 0.784466631326796),
    Eigen::Quaterniond(0.579459716051524, -0.126686716729418, 0.719157008592136, 0.361925559018174),
    Eigen::Quaterniond(-0.529266453698261, -0.126890435255464, -0.652444103731994, -0.527344792271338),
    Eigen::Quaterniond(-0.103960573071898, -0.901573639287027, 0.363338094967036, 0.210576829055414),
    Eigen::Quaterniond(0.138716366569864, -0.900736196961220, 0.177416131343537, -0.371423733044332),
    Eigen::Quaterniond(-0.877197115418306, -0.817799649173892, 0, 0),
    Eigen::Quaterniond(-0.00742222872023035, 0.188074062888242, -0.0767038639265619, -0.979126945113998),
    Eigen::Quaterniond(0.284630469170597, -0.517831889661956, -0.221032956429645, -0.775873741172379),
    Eigen::Quaterniond(-0.557468539745791, 0.682738203944287, 0.358958277180600, 0.306995647057349),
    Eigen::Quaterniond(0.674112891063761, 0.714425528181211, 0.107994087842920, -0.153314225614034),
    Eigen::Quaterniond(0.942150462885027, 0.927224401902710, 0, 0),
    Eigen::Quaterniond(0.692745775386347, -0.0222004276787922, 0.592353206556129, 0.410765274065274),
    Eigen::Quaterniond(0.0119989117810966, -0.559379798862734, 0.518132967809281, 0.646906866874593),
    Eigen::Quaterniond(-0.442248777709539, -0.547582718317428, -0.709422870412486, -0.0358939570154162),
    Eigen::Quaterniond(0.493234443656403, 0.0735756090256516, -0.356684630676089, 0.789988916116502),
    Eigen::Quaterniond(-0.526139231774260, 0.524219418422295, 0.121918389483700, 0.658412800940780),
    Eigen::Quaterniond(0.914690563238247, -0.304865699102481, 0.260574927354289, 0.0499878612061123),
    Eigen::Quaterniond(0.240520072155542, -0.0775364812170016, 0.719799912933207, -0.646549514199900),
    Eigen::Quaterniond(0.200524291015256, 0.278647524398713, 0.447436572082949, 0.825800266300489),
    Eigen::Quaterniond(-0.654790996704663, 0.834672081733690, 0, 0),
    Eigen::Quaterniond(-0.819306523713551, -0.676854852219338, 0, 0),
    Eigen::Quaterniond(-0.489475594712822, 0.431270808334947, 0.526222481587234, 0.545443885226357),
    Eigen::Quaterniond(0.717141062518420, 0.155477752384819, 0.323104052625192, -0.597611191445152),
    Eigen::Quaterniond(0.822134106795588, -0.133402045581762, 0.485811099179709, -0.265116918720449),
    Eigen::Quaterniond(0.399267534451525, 0.768485565262188, -0.254076335370232, -0.430651352861558),
    Eigen::Quaterniond(0.450364710046775, -0.213896489246174, 0.244667283594477, 0.831599567202356),
    Eigen::Quaterniond(-0.540227842285007, -0.642049694744536, 0.128154352107010, -0.528679988210795),
    Eigen::Quaterniond(0.152106912642709, 0.266667160640243, 0.894814416105068, -0.324128482693083),
    Eigen::Quaterniond(0.621256210015878, 0.248001108624688, -0.536261852459110, 0.514742068646770),
    Eigen::Quaterniond(-0.192313263231869, -0.344116806053503, 0.751474555992465, -0.529041798228245),
    Eigen::Quaterniond(0.976878534399490, 0.605930631916474, 0, 0),
    Eigen::Quaterniond(-0.820002370026223, 0.998955717271784, 0, 0),
    Eigen::Quaterniond(-0.358117934704477, 0.961956321864293, 0, 0),
    Eigen::Quaterniond(0.0228178776383559, -0.745926115610286, 0.421045671870541, -0.515552244403723),
    Eigen::Quaterniond(-0.878787266863516, -0.535519708076415, 0, 0),
    Eigen::Quaterniond(0.451375847091688, -0.952735066683550, 0, 0),
    Eigen::Quaterniond(0.113111497123984, 0.214865220803710, -0.710139447949879, 0.660863594528240),
    Eigen::Quaterniond(0.0587198049625133, -0.778381357425700, 0.374634566630806, -0.500323283890164),
    Eigen::Quaterniond(0.659964864066391, -0.185080984243202, -0.413701137407049, 0.599201782688863),
    Eigen::Quaterniond(0.717518068143608, 0.768153613323923, 0, 0),
    Eigen::Quaterniond(0.578057846627898, 0.0962655549531750, 0.788475451560805, 0.186784718773940),
    Eigen::Quaterniond(-0.364333892547543, -0.261993846576766, -0.509570732880945, 0.734137389926601),
    Eigen::Quaterniond(-0.0955850924740365, -0.583308034373306, -0.320974137586423, -0.739993804117934),
    Eigen::Quaterniond(0.504455940099885, -0.118113446951353, -0.0320129472064478, -0.854721351879295),
    Eigen::Quaterniond(-0.780276588498629, 0.912392304351756, 0, 0),
    Eigen::Quaterniond(-0.780515262812193, -0.751948166703914, 0, 0),
    Eigen::Quaterniond(-0.460232672591198, -0.0584735082660863, 0.868278041318695, 0.175670085314462),
    Eigen::Quaterniond(0.0492746907926218, 0.713792655564387, -0.462521057271811, -0.523589840705298),
    Eigen::Quaterniond(0.945302153954994, -0.913219056866094, 0, 0),
    Eigen::Quaterniond(0.420817370556339, 0.383250290402611, 0.710393638689324, 0.413972020375901),
    Eigen::Quaterniond(-0.376280109704934, 0.957970933350077, 0, 0),
    Eigen::Quaterniond(-0.417085744704545, -0.433464203015726, 0.591045267431329, -0.537413954150081),
    Eigen::Quaterniond(0.700714674749243, -0.732439000011154, 0, 0),
    Eigen::Quaterniond(0.823294848015707, 0.370559368825375, 0.191489530614149, 0.384971566575646),
    Eigen::Quaterniond(0.278552294552128, 0.818909111498789, 0.332230893073047, -0.376057336043181),
    Eigen::Quaterniond(-0.489259404111113, 0.221737964766487, -0.295682896380220, -0.789955147624382),
    Eigen::Quaterniond(-0.822668319935434, 0.799965592865722, 0, 0),
    Eigen::Quaterniond(0.676511175074452, -0.613132496121816, 0.316300079547791, -0.257595481087843),
    Eigen::Quaterniond(0.169437238526641, 0.508849162976500, 0.138194625215966, 0.832625844602484),
    Eigen::Quaterniond(0.896217470792044, -0.307478566670450, 0.290823738167753, 0.132938818271908),
    Eigen::Quaterniond(-0.877942141614982, -0.162749171394574, 0.308849946329922, 0.327630910994191),
    Eigen::Quaterniond(0.169282606710221, -0.688560339290216, -0.0743529750235778, 0.701213015657210),
    Eigen::Quaterniond(-0.429783828682716, 0.638001167853682, 0.634606025647272, 0.0742668339996906),
    Eigen::Quaterniond(0.655464346896526, 0.249847055692555, 0.650444363572203, -0.291316097403531),
    Eigen::Quaterniond(-0.618027118605204, 0.477120843221295, -0.550471783815543, 0.295599385749164),
    Eigen::Quaterniond(-0.114940075594233, 0.610224841413908, -0.206856931060040, -0.756058616785885),
    Eigen::Quaterniond(-0.213176987264847, -0.865554684873643, 0.368543600121498, -0.263716276333974),
    Eigen::Quaterniond(0.653147958085530, 0.901580633011132, 0, 0),
    Eigen::Quaterniond(0.353742186876838, -0.00484597795567865, 0.302788778331755, 0.884964370716476),
    Eigen::Quaterniond(-0.584793931240039, 0.510291809401044, 0.409293348246137, 0.479684565443267),
    Eigen::Quaterniond(-0.363790547699474, 0.484810141353884, 0.633460537901180, -0.480981612088126),
    Eigen::Quaterniond(-0.732378029287748, 0.662259151420226, 0.154760662651231, -0.0329298629287809),
    Eigen::Quaterniond(0.342925778956061, -0.686996306499597, -0.594796696477332, 0.238022845212267),
    Eigen::Quaterniond(0.141982150924811, -0.0853825588971828, -0.898544542431900, -0.406409390542074),
    Eigen::Quaterniond(-0.660465867947023, 0.236200992188762, 0.299960842058251, 0.646542668195793),
    Eigen::Quaterniond(-0.704688445696526, 0.864366710094101, 0, 0),
    Eigen::Quaterniond(-0.0478405634650874, 0.670176471118703, 0.731773209418769, -0.114379840982494),
    Eigen::Quaterniond(0.816204833013900, 0.790847032684700, 0, 0),
    Eigen::Quaterniond(0.104350053431669, 0.165037049336060, 0.528966439132603, 0.825874291261466),
    Eigen::Quaterniond(-0.934120214500247, 0.165493612723583, 0.0184771981257470, 0.315737045908667),
    Eigen::Quaterniond(-0.892274147128888, 0.709851877939910, 0, 0),
    Eigen::Quaterniond(0.610126457117804, -0.930268599904139, 0, 0),
    Eigen::Quaterniond(-0.0972502905931036, 0.770840190969607, 0.0575044484672664, 0.626929836083730),
    Eigen::Quaterniond(-0.234707540880083, -0.184538377288036, -0.846518743567180, -0.440753870489376),
    Eigen::Quaterniond(0.579287407379381, -0.927235939104336, 0, 0),
    Eigen::Quaterniond(-0.271426261000412, 0.492295885475441, 0.0358225480802150, 0.826250138294892),
    Eigen::Quaterniond(0.0646998699978207, -0.690342458497789, -0.637560535636518, -0.335794252804258),
    Eigen::Quaterniond(0.423313411962533, -0.712183342650264, 0.471512025090953, -0.302120922643175),
    Eigen::Quaterniond(0.742953035991693, 0.211918106647494, -0.234286885327646, 0.590102667125931),
    Eigen::Quaterniond(-0.342620776655542, -0.491038311897263, -0.425242755526763, -0.678720103227424),
    Eigen::Quaterniond(0.300236050795554, -0.351691589988356, -0.786785012929527, -0.408828427049339),
    Eigen::Quaterniond(0.949672296005515, -0.196418164306003, -0.219607663983680, 0.106371560343470),
    Eigen::Quaterniond(-0.848065277411729, -0.187253357197746, -0.334685327604057, -0.365659947154875),
    Eigen::Quaterniond(0.174038334165544, -0.227617722878175, 0.714261162198204, 0.638538818434642),
    Eigen::Quaterniond(-0.172227004453280, 0.219603647675910, -0.791210302563173, 0.544149201949592),
    Eigen::Quaterniond(-0.381727147067466, -0.666218554667508, -0.640635367690760, 0.00485265619986119),
    Eigen::Quaterniond(-0.472331916946410, -0.623815853609503, -0.512238274835849, 0.354073849376609),
    Eigen::Quaterniond(0.517532530160408, -0.810742260275669, 0.215871127706017, 0.168097364202411),
    Eigen::Quaterniond(0.990431962259504, -0.353627454477471, 0, 0),
    Eigen::Quaterniond(-0.626857111717262, 0.539193858544670, 0.523266569264104, 0.206184970082151),
    Eigen::Quaterniond(0.562290537069529, -0.531763995082003, 0.163105944231693, -0.611925531754294),
    Eigen::Quaterniond(-0.608404037946536, 0.480730939248525, 0.630484680813902, 0.0350907098613514),
    Eigen::Quaterniond(0.984717946359853, 0.385636827663459, 0, 0),
    Eigen::Quaterniond(0.604523139528578, 0.648156426732761, 0.347766690817183, 0.305783173208726),
    Eigen::Quaterniond(-0.151546580193388, 0.655955098278974, 0.739420323294250, -0.00375879940110859),
    Eigen::Quaterniond(0.457727736102748, -0.413264131983216, -0.705532188764914, -0.349173892831353),
    Eigen::Quaterniond(-0.00329283495289667, -0.381261515154502, -0.200007173035253, 0.902566310602447),
    Eigen::Quaterniond(0.617980534398090, 0.0460595968839861, -0.302560829602587, 0.724179202290518),
    Eigen::Quaterniond(-0.286982133037908, -0.349402015011148, 0.889405486763038, 0.0672113631684806),
    Eigen::Quaterniond(-0.853513131020385, 0.663685020972136, 0, 0),
    Eigen::Quaterniond(0.181982910549699, 0.620589581487681, 0.194613331015218, -0.737479791592940),
    Eigen::Quaterniond(0.820375661456283, 0.113996522557218, 0.143694082812195, -0.541609247982151),
    Eigen::Quaterniond(-0.612468127666779, -0.474071932539686, 0.279653167155982, -0.567391136227969),
    Eigen::Quaterniond(-0.135264416931205, 0.361132404608900, -0.411227436048199, -0.825941232591568),
    Eigen::Quaterniond(0.498319458136018, -0.532693709115230, -0.674304041781248, -0.115018212251609),
    Eigen::Quaterniond(-0.921631026704834, -0.0871492707737762, 0.0276365987280761, -0.377143836790867),
    Eigen::Quaterniond(0.892649979610965, -0.230866210976952, -0.166390609550427, 0.349558252059834),
    Eigen::Quaterniond(0.527346647327522, 0.0772028773960436, -0.586093173738093, -0.610278642074096),
    Eigen::Quaterniond(0.117641101019121, 0.983407441923910, -0.0523654326593582, -0.127781986140769),
    Eigen::Quaterniond(-0.632314111068451, 0.510440803355660, -0.135901415866698, -0.566709675564808),
    Eigen::Quaterniond(-0.00410236996210611, 0.960909698860749, 0.0707343011194701, -0.267642260940195),
    Eigen::Quaterniond(0.0356912004681014, -0.530434718674305, 0.518529123365389, -0.669695972554695),
    Eigen::Quaterniond(0.988486021288101, 0.0571181771053302, 0.126948427275857, 0.0593042694447137),
    Eigen::Quaterniond(0.709703366181350, -0.897127892866184, 0, 0),
    Eigen::Quaterniond(0.924807879423942, 0.513750941969245, 0, 0),
    Eigen::Quaterniond(0.357882017954067, 0.203959532551020, -0.446057537530600, -0.794577651031560),
    Eigen::Quaterniond(-0.192997222391279, 0.714337418244418, -0.123320703166912, -0.661261014437998),
    Eigen::Quaterniond(0.869958172356103, 0.976554278516228, 0, 0),
    Eigen::Quaterniond(-0.0410309087350369, 0.858968944851235, 0.314400160924803, 0.402046458907415),
    Eigen::Quaterniond(-0.536416776673766, -0.180970133122369, -0.0861904260540613, -0.819803673495806),
    Eigen::Quaterniond(-0.207419502980449, -0.999317075563722, 0, 0),
    Eigen::Quaterniond(0.410154950225578, 0.0817566455260865, -0.696560256669384, -0.583003067355960),
    Eigen::Quaterniond(0.117118069121100, -0.584538756007881, 0.469916578146120, 0.650980959931660),
    Eigen::Quaterniond(0.513261401788735, -0.561432823635139, 0.0146748547395451, 0.648953439483381),
    Eigen::Quaterniond(0.990962117110516, -0.348387474531556, 0, 0),
    Eigen::Quaterniond(0.924862808733268, -0.808101166784831, 0, 0),
    Eigen::Quaterniond(0.0701342105123139, 0.495067323476606, -0.865931032901842, 0.0123686700607924),
    Eigen::Quaterniond(0.927740259943429, 0.497017914786584, 0, 0),
    Eigen::Quaterniond(-0.768748241637482, 0.0865988661702177, -0.237008060226963, -0.587668236971138),
    Eigen::Quaterniond(-0.897103413539589, -0.323735366951894, 0.296406429674466, 0.0504391321076724),
    Eigen::Quaterniond(-0.391302108726853, 0.664667323241057, -0.621610577307189, 0.136749037661370),
    Eigen::Quaterniond(0.160383666285425, 0.105144356051915, 0.741247022822945, -0.643253134570982),
    Eigen::Quaterniond(0.0619289046765630, 0.915086233924042, 0.393625127967348, 0.0619778499220832),
    Eigen::Quaterniond(0.802416185306287, 0.785666638636003, 0, 0),
    Eigen::Quaterniond(0.0811008503404886, -0.286992765745991, 0.952357957246092, -0.0638132098672957),
    Eigen::Quaterniond(-0.136038778286635, 0.0928037859837745, 0.747879869537315, 0.643083671733474),
    Eigen::Quaterniond(0.0853339748726831, -0.306636497490102, -0.926155849176678, -0.202305497145426),
    Eigen::Quaterniond(0.424829611579043, 0.245605581318261, 0.549079707696583, -0.676542071231903),
    Eigen::Quaterniond(-0.966650574119535, 0.593249370616792, 0, 0),
    Eigen::Quaterniond(0.601841764115696, 0.491749803081300, -0.354684346851665, 0.519776525281796),
    Eigen::Quaterniond(-0.714981350152419, -0.748927537290361, 0, 0),
    Eigen::Quaterniond(-0.0430510541942737, 0.644788013518041, 0.545743650788289, -0.533440617107932),
    Eigen::Quaterniond(-0.486329291640733, -0.949698997142996, 0, 0),
    Eigen::Quaterniond(-0.261816622350279, -0.171142238151937, 0.494014110022808, -0.811241301759107),
    Eigen::Quaterniond(0.323529826730829, 0.462814935945874, 0.410155868592107, 0.716172430173342),
    Eigen::Quaterniond(-0.660782373091371, 0.562748000551926, 0.490157957397133, 0.0801655791896783),
    Eigen::Quaterniond(-0.442431959121963, -0.265428169737262, 0.657481675746943, 0.549108089827878),
    Eigen::Quaterniond(-0.603556410972322, 0.489735712483345, -0.512136851340099, 0.365505726620102),
    Eigen::Quaterniond(-0.609856933431478, 0.784534376462215, 0.0801062793861510, -0.0785067952314013),
    Eigen::Quaterniond(-0.346320703300049, -0.514793227440661, 0.0600993475649396, -0.781944992866670),
    Eigen::Quaterniond(0.760675720758399, -0.740806048324920, 0, 0),
    Eigen::Quaterniond(-0.0577962699685031, -0.549864235744173, -0.751346704619502, 0.360259688120414),
    Eigen::Quaterniond(-0.192061255658118, -0.299972161998468, 0.0832449346125949, -0.930698370559623),
    Eigen::Quaterniond(-0.641537047153107, -0.425830773707648, 0.290543422206420, 0.568051836636588),
    Eigen::Quaterniond(0.937849992294584, 0.854976014358856, 0, 0)};

static const Eigen::Quaterniond Qavg_true(-0.614272845931959, 0.779235109150709, 0.103521424946004, 0.0688827263882945);


TEST_CASE("Test Quaternion", "[utility][math][Quaternion]") {

    INFO("Calculating average quaternion");
    Eigen::Quaterniond Qavg = utility::math::quaternion::mean(Q.begin(), Q.end());

    Eigen::Quaterniond diff_f = utility::math::quaternion::difference(Qavg, Qavg_true);
    Eigen::Quaterniond diff_b = utility::math::quaternion::difference(Qavg_true, Qavg);

    INFO("The real part of the forward difference: " << diff_f.w() << ". This should be 1.0.");
    INFO("The real part of the backward difference: " << diff_b.w() << ". This should be 1.0.");
    INFO("The norm of the imaginary part of the forward difference: " << diff_f.vec().norm()
                                                                      << ". This should be small.");
    INFO("The norm of the imaginary part of the backward difference: " << diff_b.vec().norm()
                                                                       << ". This should be small.");

    REQUIRE_THAT(diff_f.w(), WithinAbs(1.0, 1e-6));
    REQUIRE_THAT(diff_b.w(), WithinAbs(1.0, 1e-6));
    REQUIRE(diff_f.vec().norm() <= 1e-6);
    REQUIRE(diff_b.vec().norm() <= 1e-6);
}
